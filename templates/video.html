<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>教學影片區</title>
    <link rel="stylesheet" href="/static/video.css">
    <style>
        /* 書籍推薦面板樣式 */
        .book-recommendations {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 320px;
            max-height: 70vh;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 20px;
            overflow-y: auto;
            z-index: 1000;
            border: 1px solid #e0e6ed;
            font-family: 'Microsoft JhengHei', sans-serif;
        }

        .book-recommendations h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .book-item {
            display: flex;
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fafbfc;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .book-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: #f0f7ff;
        }

        .book-cover {
            width: 60px;
            height: 80px;
            background: #ddd;
            border-radius: 4px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 12px;
            text-align: center;
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .book-info {
            flex: 1;
        }

        .book-title {
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .book-author {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 6px;
        }

        .book-description {
            font-size: 12px;
            color: #555;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .book-source {
            font-size: 10px;
            color: #3498db;
            margin-top: 4px;
            font-style: italic;
        }

        .loading-books {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 20px;
        }

        .no-books {
            text-align: center;
            color: #95a5a6;
            font-style: italic;
            padding: 20px;
        }

        .keywords-display {
            background: #ecf0f1;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #2c3e50;
        }

        .keywords-display strong {
            color: #3498db;
        }

        /* 響應式設計 */
        @media (max-width: 1400px) {
            .book-recommendations {
                width: 280px;
            }
        }

        @media (max-width: 1200px) {
            .book-recommendations {
                position: relative;
                top: 0;
                right: 0;
                width: 100%;
                max-height: none;
                margin-top: 20px;
            }
        }

        /* 調整主容器以適應書籍推薦面板 */
        .container {
            margin-right: 340px;
        }

        @media (max-width: 1200px) {
            .container {
                margin-right: 0;
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="topbar">
        <div class="system-title">機器學習教學平台</div>
        <div>
            <span class="user-label">歡迎，{{ username }}</span>
            <a href="{{ url_for('dashboard') }}" class="logout-link">AI對話</a>
            <a href="{{ url_for('logout') }}" class="logout-link">登出</a>
        </div>
    </div>

    <!-- 書籍推薦面板 -->
    <div class="book-recommendations" id="bookRecommendations">
        <h3>📚 相關書籍推薦</h3>
        <div id="booksList">
            <div class="no-books">開始對話即可獲得書籍推薦 ✨</div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <h2>機器學習 &gt;</h2>

            <!-- 資料預處理 -->
            <div class="dropdown">
                <button class="dropdown-btn">
                    資料預處理
                    <span class="arrow">&#9660;</span> <!-- ▼ -->
                </button>
                <div class="dropdown-content">
                    <button data-src="https://www.youtube.com/embed/eFqX6miUkNE">資料預處理 #1</button>
                    <button data-src="https://www.youtube.com/embed/7pDI5BrnzT0">資料預處理 #2</button>
                    <button data-src="https://www.youtube.com/embed/Wm2WW-9ucec">資料預處理 #3</button>
                    <button data-src="https://www.youtube.com/embed/rlp3WCKh8nA">資料預處理 #4</button>
                    <button data-src="https://www.youtube.com/embed/2m6G80E769s">資料預處理 #5</button>
                </div>
            </div>

            <!-- 簡單線性回歸 -->
            <div class="dropdown">
                <button class="dropdown-btn">
                    簡單線性回歸
                    <span class="arrow">&#9660;</span>
                </button>
                <div class="dropdown-content">
                    <button data-src="https://www.youtube.com/embed/TlQph9btXXg">簡單線性回歸 #1</button>
                    <button data-src="https://www.youtube.com/embed/0OrQEy0PUu8">簡單線性回歸 #2</button>
                    <button data-src="https://www.youtube.com/embed/Z5Qr1WCm-0s">簡單線性回歸 #3</button>
                    <button data-src="https://www.youtube.com/embed/HVv2T2_X6_I">簡單線性回歸 #4</button>
                </div>
            </div>

            <!-- 多元線性回歸 -->
            <div class="dropdown">
                <button class="dropdown-btn">
                    多元線性回歸
                    <span class="arrow">&#9660;</span>
                </button>
                <div class="dropdown-content">
                    <button data-src="https://www.youtube.com/embed/S4DZyq6YnXE">多元線性回歸 #1</button>
                    <button data-src="https://www.youtube.com/embed/ycDNXdt4B9s">多元線性回歸 #2</button>
                    <button data-src="https://www.youtube.com/embed/_azK56iLmS4">多元線性回歸 #3</button>
                </div>
            </div>

            <!-- 多項式回歸 -->
            <div class="dropdown">
                <button class="dropdown-btn">
                    多項式回歸
                    <span class="arrow">&#9660;</span>
                </button>
                <div class="dropdown-content">
                    <button data-src="https://www.youtube.com/embed/rmrnBM3mVsQ">多項式回歸 #1</button>
                    <button data-src="https://www.youtube.com/embed/_q5SyL82Vc8">多項式回歸 #2</button>
                </div>
            </div>

            <!-- R Squared -->
            <div class="dropdown">
                <button class="dropdown-btn">
                    R Squared
                    <span class="arrow">&#9660;</span>
                </button>
                <div class="dropdown-content">
                    <button data-src="https://www.youtube.com/embed/Pa2oVPYPQYY">R Squared (R平方)</button>
                    <button data-src="https://www.youtube.com/embed/H8OVpXKnh5c">R Squared介紹</button>
                    <button data-src="https://www.youtube.com/embed/ewNrzR5s3E8">Adjusted R Squared (調整R平方)係數</button>
                    <button data-src="https://www.youtube.com/embed/vOCB46P_WCM">Adjusted R Squared介紹</button>
                </div>
            </div>

            <!-- Support Vector Machine -->
            <div class="dropdown">
                <button class="dropdown-btn">
                    Support Vector Machine
                    <span class="arrow">&#9660;</span>
                </button>
                <div class="dropdown-content">
                    <button data-src="https://www.youtube.com/embed/afDRvWxobP8">SVM介紹</button>
                    <button data-src="https://www.youtube.com/embed/teJ-9ihjmcI">SVM Python實務操作</button>
                    <button data-src="https://www.youtube.com/embed/namj9uIwjaE">SVM Python實務操作 (使用MNIST資料集合)</button>
                </div>
            </div>

            <!-- Naive Bayes -->
            <div class="dropdown">
                <button class="dropdown-btn">
                    Naive Bayes(單純貝氏分類器)
                    <span class="arrow">&#9660;</span>
                </button>
                <div class="dropdown-content">
                    <button data-src="https://www.youtube.com/embed/1bc7EOx48mo">Naive Bayes介紹 Part 1</button>
                    <button data-src="https://www.youtube.com/embed/tlJfftcWMCw">Naive Bayes介紹 Part 2</button>
                    <button data-src="https://www.youtube.com/embed/nqrkfeaq3tU">Naive Bayes介紹 Part 3</button>
                </div>
            </div>

            <!-- Decision Tree(決策樹) -->
            <div class="dropdown">
                <button class="dropdown-btn">
                    Decision Tree(決策樹)
                    <span class="arrow">&#9660;</span>
                </button>
                <div class="dropdown-content">
                    <button data-src="https://www.youtube.com/embed/bE2yMLKJFbk">Decision Tree介紹 Part 1</button>
                    <button data-src="https://www.youtube.com/embed/yfDLN82D6Gc">Decision Tree介紹 Part 2</button>
                    <button data-src="https://www.youtube.com/embed/Pwp7dxlv5MY">Decision Tree Python實作</button>
                    <button data-src="https://www.youtube.com/embed/WWjZb38YIHE">Decision Tree介紹 Part 3</button>
                </div>
            </div>

            <!-- Random Forest (隨機森林) -->
            <div class="dropdown">
                <button class="dropdown-btn">
                    Random Forest (隨機森林)
                    <span class="arrow">&#9660;</span>
                </button>
                <div class="dropdown-content">
                    <button data-src="https://www.youtube.com/embed/wIXMzMsjULQ">Random Forest (隨機森林)</button>
                    <button data-src="https://www.youtube.com/embed/3U8N5sPdQPk">Random Forest (隨機森林) Python實作</button>
                </div>
            </div>

            <!-- K-Means (K平均) -->
            <div class="dropdown">
                <button class="dropdown-btn">
                    K-Means (K平均)
                    <span class="arrow">&#9660;</span>
                </button>
                <div class="dropdown-content">
                    <button data-src="https://www.youtube.com/embed/A5gK564vHmE">K-Means (K平均) Part 1</button>
                    <button data-src="https://www.youtube.com/embed/13g6powgeUM">K-Means (K平均) Part 2</button>
                    <button data-src="https://www.youtube.com/embed/F16VusxMMSU">K-Means (K平均) Part 3</button>
                    <button data-src="https://www.youtube.com/embed/4oP318KqXGo">K-Means (K平均) Python實作</button>
                </div>
            </div>

            <!-- K-Fold Cross Validation (交叉驗證)  -->
            <div class="dropdown">
                <button class="dropdown-btn">
                    K-Fold Cross Validation (交叉驗證)
                    <span class="arrow">&#9660;</span>
                </button>
                <div class="dropdown-content">
                    <button data-src="https://www.youtube.com/embed/sRV18JVtBQI">K-Fold Cross Validation (交叉驗證)
                        #1</button>
                    <button data-src="https://www.youtube.com/embed/DPcFlzF9zSk">K-Fold Cross Validation (交叉驗證)
                        #2</button>
                </div>
            </div>

            <!-- Grid Search (網格搜尋)  -->
            <div class="dropdown">
                <button class="dropdown-btn">
                    Grid Search (網格搜尋)
                    <span class="arrow">&#9660;</span>
                </button>
                <div class="dropdown-content">
                    <button data-src="https://www.youtube.com/embed/k1xsoog2y3Q">Grid Search (網格搜尋) Python實作</button>
                </div>
            </div>

            <!-- AI 機器人按鈕 -->
            <button class="aiRobot-btn" onclick="toggleChat()" title="開啟 AI 聊天">
                <img src="/static/aiRobot.png" alt="AI 機器人" />
            </button>

            <!-- 對話視窗 -->
            <div id="chatWindow" class="chat-window hidden">
                <div class="chat-header">
                    AI 機器人 🤖
                    <button class="close-btn" onclick="toggleChat()">✖</button>
                </div>
                <div class="chat-messages" id="chat-messages"></div>
                <form id="chat-form" class="chat-form" autocomplete="off">
                    <input id="chat-input" type="text" placeholder="輸入訊息..." required />
                    <button type="submit">發送</button>
                    <button type="button" id="clearBtn">清除</button>
                </form>
            </div>
        </div>

        <!-- 影片與聊天區 -->
        <main class="main">
            <h2>機器學習 - 資料預處理 #1 by 國立屏東大學林彥廷老師</h2>
            <div class="video-wrapper">
                <!-- 你可以換成 <video> or iframe -->
                <iframe id="videoPlayer" width="100%" height="100%" src="https://www.youtube.com/embed/eFqX6miUkNE"
                    frameborder="0" allowfullscreen>
                </iframe>
            </div>
        </main>
    </div>

    <script>
        // 書籍推薦功能
        async function getBookRecommendations(userMessage) {
            try {
                const response = await fetch('/get_book_recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userMessage }),
                });

                const data = await response.json();
                displayBookRecommendations(data.books, data.keywords);
            } catch (error) {
                console.error('獲取書籍推薦失敗:', error);
            }
        }
        function displayBookRecommendations(books, keywords) {
            const booksList = document.getElementById('booksList');

            if (!books || books.length === 0) {
                booksList.innerHTML = '<div class="no-books">暫無相關書籍推薦</div>';
                return;
            }

            let html = '';

            if (keywords) {
                html += `<div class="keywords-display"><strong>關鍵詞:</strong> ${keywords}</div>`;
            }

            books.forEach(book => {
                html += `
                    <a id = "bookstore" href="${book.link}">
                       <div class="book-item">
                        <img class="book-cover" src="${book.image}" alt="${book.title}">
                        <div class="book-info">
                            <div class="book-title">${book.title}</div>
                            <div class="book-author">作者: ${book.author}</div>
                            <div class="book-source">${book.source || '推薦書籍'}</div>
                        </div>
                    </div> 
                    </a>
                `;
            });

            booksList.innerHTML = html;
        }

        function showBookLoading() {
            const booksList = document.getElementById('booksList');
            booksList.innerHTML = '<div class="loading-books">🔍 正在搜尋相關書籍...</div>';
        }

        // 綜合所有 DOMContentLoaded 的初始化內容為一段，避免重複與潛在順序錯誤
        window.addEventListener("DOMContentLoaded", function () {
            // dropdown 點擊展開/收合
            const dropdowns = document.querySelectorAll(".dropdown-btn");
            dropdowns.forEach(btn => {
                btn.addEventListener("click", function () {
                    const content = this.nextElementSibling;
                    const arrow = this.querySelector(".arrow");
                    const isOpen = content.style.display === "block";
                    content.style.display = isOpen ? "none" : "block";
                    arrow.innerHTML = isOpen ? "&#9660;" : "&#9650;"; // ▼ ▲
                });
            });

            // 點擊影片按鈕切換 iframe src 與標題 + active 樣式切換
            const buttons = document.querySelectorAll(".dropdown-content button");
            const iframe = document.getElementById("videoPlayer");
            buttons.forEach(btn => {
                btn.addEventListener("click", function () {
                    const videoUrl = this.getAttribute("data-src");
                    iframe.src = videoUrl;

                    const title = document.querySelector(".main h2");
                    title.textContent = "機器學習 - " + this.textContent + " by 國立屏東大學林彥廷老師";

                    buttons.forEach(b => b.classList.remove("active"));
                    this.classList.add("active");
                });
            });

            // sidebar 滾動特效
            const sidebar = document.querySelector('.sidebar');
            sidebar.addEventListener('mouseenter', () => sidebar.classList.add('scrollable'));
            sidebar.addEventListener('mouseleave', () => sidebar.classList.remove('scrollable'));

            // 初始歡迎訊息與歷史紀錄載入
            addMessage('ai', '你好！有什麼我可以幫忙的嗎？');
            fetch('/chat/history')
                .then(res => res.json())
                .then(history => {
                    if (Array.isArray(history)) {
                        for (const msg of history) addMessage(msg.role, msg.content);
                    } else if (history.error) {
                        addMessage('ai', '⚠️ 無法載入歷史紀錄：' + history.error);
                    }
                })
                .catch(() => addMessage('ai', '⚠️ 載入紀錄時出錯。'));
        });

        // 切換聊天視窗顯示/隱藏
        function toggleChat() {
            const chatWindow = document.getElementById("chatWindow");
            const botBtn = document.querySelector(".aiRobot-btn");
            const isHidden = chatWindow.classList.contains("hidden");
            chatWindow.classList.toggle("hidden", !isHidden);
            botBtn.style.display = isHidden ? "none" : "block";
        }

        // 加入訊息至聊天框
        function addMessage(sender, text) {
            const chatMessages = document.getElementById('chat-messages');
            const messageRow = document.createElement("div");
            messageRow.classList.add("message-row", sender);
            const bubble = document.createElement("div");
            bubble.classList.add("bubble", sender);
            bubble.textContent = text;
            messageRow.appendChild(bubble);
            chatMessages.appendChild(messageRow);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 清除聊天紀錄與輸入框
        const clearBtn = document.getElementById('clearBtn');
        clearBtn.addEventListener('click', async () => {
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            chatMessages.innerHTML = '';
            chatInput.value = '';

            // 清除書籍推薦
            const booksList = document.getElementById('booksList');
            booksList.innerHTML = '<div class="no-books">開始對話即可獲得書籍推薦 ✨</div>';

            try {
                const res = await fetch('/chat/clear', { method: 'POST' });
                const result = await res.json();
                if (result.success) {
                    addMessage('ai', '你好！有什麼我可以幫忙的嗎？');
                } else {
                    addMessage('ai', '清除紀錄失敗：' + (result.error || '未知錯誤'));
                }
            } catch (e) {
                addMessage('ai', '清除伺服器紀錄時發生錯誤');
                console.error(e);
            }
        });

        // 提交訊息處理
        const chatForm = document.getElementById('chat-form');
        chatForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const chatInput = document.getElementById('chat-input');
            const text = chatInput.value.trim();
            if (!text) return;

            // 加入使用者訊息
            addMessage('user', text);
            chatInput.value = '';
            chatInput.focus();

            // 顯示書籍推薦載入狀態
            showBookLoading();

            // 顯示 AI 輸入中（三個點動畫）
            const chatMessages = document.getElementById('chat-messages');
            const typingRow = document.createElement("div");
            typingRow.classList.add("message-row", "ai");
            typingRow.setAttribute("id", "typingIndicator");

            const typingBubble = document.createElement("div");
            typingBubble.classList.add("bubble", "ai", "typing");
            typingBubble.innerHTML = "<span></span><span></span><span></span>";

            typingRow.appendChild(typingBubble);
            chatMessages.appendChild(typingRow);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // 同時發送聊天和書籍推薦請求
                const [chatResponse, bookResponse] = await Promise.all([
                    fetch('/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text }),
                    }),
                    getBookRecommendations(text)
                ]);

                const chatData = await chatResponse.json();

                // 移除輸入中提示
                const typingEl = document.getElementById("typingIndicator");
                if (typingEl) typingEl.remove();

                // 加入 AI 真正的回覆
                if (chatData.reply) {
                    addMessage('ai', chatData.reply);
                } else if (chatData.error) {
                    addMessage('ai', '錯誤：' + chatData.error);
                }
            } catch (error) {
                // 移除輸入中提示
                const typingEl = document.getElementById("typingIndicator");
                if (typingEl) typingEl.remove();

                addMessage('ai', '伺服器錯誤，請稍後再試。');

                // 如果聊天失敗，也清除書籍推薦的載入狀態
                const booksList = document.getElementById('booksList');
                booksList.innerHTML = '<div class="no-books">獲取推薦失敗，請稍後再試</div>';
            }
        });

        // 拖曳聊天視窗
        window.addEventListener("DOMContentLoaded", () => {
            const chatWindow = document.getElementById("chatWindow");
            const chatHeader = chatWindow.querySelector(".chat-header");
            let isDragging = false;
            let offsetX = 0;
            let offsetY = 0;

            chatHeader.addEventListener("mousedown", (e) => {
                isDragging = true;
                offsetX = e.clientX - chatWindow.offsetLeft;
                offsetY = e.clientY - chatWindow.offsetTop;
                chatWindow.style.transition = "none";
            });

            document.addEventListener("mousemove", (e) => {
                if (isDragging) {
                    chatWindow.style.left = `${e.clientX - offsetX}px`;
                    chatWindow.style.top = `${e.clientY - offsetY}px`;
                    chatWindow.style.bottom = "auto";
                    chatWindow.style.right = "auto";
                    chatWindow.style.position = "fixed";
                }
            });

            document.addEventListener("mouseup", () => {
                isDragging = false;
                chatWindow.style.transition = "";
            });
        });
    </script>

</body>

</html>